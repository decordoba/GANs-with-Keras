# GANs with Keras

Implementation of Generative Adversarial Networks (GANs) using Keras 2. Generate original artificial images similar to a dataset of real images but completely new.

Two adversarial deep neural networks (the generator and the discriminator) are trained on real images, in order to produce artificial images that look real.

The Generator model tries to produce images that look real and are thought to be real by the Discriminator. The Discriminator model tries to tell real images apart from the artificial images generated by the Generator. 
Therefore, this is a game of two adversaries, G and D, and for this reason we call them adversarial networks.

This project's code is based on this repository: https://github.com/jacobgil/keras-dcgan

## Sample results

I will add some images here soon.

## Installation

Run the following to install all the dependencies:

`bash get_dependencies.sh`

If your system cannot run bash commands, simply clone the `deep-learning-with-Keras` repository, copy at the same level of `dcgan.py` all the files starting with `keras_` and install the required pip wheels:

```
git clone https://github.com/decordoba/deep-learning-with-Keras.git
cp deep-learning-with-Keras/keras_* .

pip3 install keras tensorflow matplotlib pydot h5py --user
```

Make sure that once this is done, `python3 dcgan.py -d mnist` works. Refer to the Troubleshooting section if you run into any issue (you probably need to install a few more things).

## Usage
`dcgan.py` will train the GAN or generate new images from an already trained GAN.

Run `python3 dcgan.py -h` to see how to use the file:
```
$ python3 dcgan.py --help
usage: dcgan.py [-h] [-m {train,generate}] [-f FOLDER]
                [-d {mnist,cifar10,lumps1,lumps2}] [-bs BATCH_SIZE]
                [-ne NUMBER_EPOCHS] [-ns NOISE_SIZE] [-sf SAVE_FREQUENCY] [-n]
                [-mc]

optional arguments:
  -h, --help            show this help message and exit
  -m {train,generate}, --mode {train,generate}
                        'train' will train a GAN on the selected dataset.
                        'generate' will generate new images from a trained
                        GAN. Default is 'train'.
  -f FOLDER, --folder FOLDER
                        Folder where to save data if training / extract data
                        from if generating.
  -d {mnist,cifar10,lumps1,lumps2}, --dataset {mnist,cifar10,lumps1,lumps2}
                        Only used in 'train' mode. Dataset used for training.
                        Default is 'lumps1'.
  -bs BATCH_SIZE, --batch_size BATCH_SIZE
                        Batch size while training. Also number of samples
                        saved in every image when training and generating.
                        Default is 128.
  -ne NUMBER_EPOCHS, --number_epochs NUMBER_EPOCHS
                        Only used in 'train' mode. Number of epochs the GAN
                        will be trained. Default is 100.
  -ns NOISE_SIZE, --noise_size NOISE_SIZE
                        Only used in 'train' mode. Length of random input
                        vector that the generator expects. Default is 100.
  -sf SAVE_FREQUENCY, --save_frequency SAVE_FREQUENCY
                        Only used in 'train' mode. How often a new weights
                        file is created (how many epochs between the different
                        weight files are created). Default is 10.
  -n, --nice            Only used in 'generate' mode. Generate more samples
                        and show only the ones that scored higher according to
                        the discriminator.
  -mc, --manual_config  Only used in 'generate' mode. If no config file
                        exists, the required values can be entered manually.
```

There are two modes: `train` and `generate`. 

In *train mode*, the batch size, the number of epochs, the noise size, the dataset and the folder where the result will be saved can be set from command line. 

Just try it out! Run:
`python3 dcgan.py -d mnist`

or, if you want to be more specific, run:
`python3 dcgan.py -m trawn -d mnist -f my_first_gan -bs 64 -ne 100 -ns 100 -sf 10`

This will trigger several actions:
1. A folder will be created in output/mnist/ called YYYY-MM-DD_hh.mm.ss (the current date), unless you select a different name using the `-f` option.
2. The selected dataset (mnist) will be loaded. This may take a few minutes.
3. A window will appear showing all images in the dataset, one at a time. We can go to the next one typing ENTER or stop the samples viewer typing q + ENTER
4. The generator and discriminator models are created and compiled. The models used can be selected modifying the arguments passed in the main function. The default models are found in `gan_models.py`.
5. The generator, discriminator and GAN models are saved in the `output/dataset/` with the names `generator-model.png`, `discriminator_model.png` and `gan_model.png`.
6. We enter the main loop where we will train the GAN. Every 20 batches, some feedback is printed (the epoch number, the batch number, the loss, the time, etc.). At the end of every epoch, the generator and discriminator weights are saved (so we can generate and discriminate images using those models), the results are saved in a `results.yaml` file, and the configuration is updated in `config.yaml` file. `config.yaml` will be used in the generate mode to know the setup used originally. `results.yaml` will be used by `gan_loss_observer.py` to plot a graph of how the loss evolves.
7. Once we have looped over all the epochs, the execution ends. This process can take several hours, to speed it up reduce the number of epochs, or simplify the model used.

*Generate mode* only works if we have previously trained a GAN and use the option `-f` to select where the weights and configuration files were saved. This option will generate new images using the selected models. 

Test it out, once you running:
`python3 dcgan.py -m generate -f output/mnist/my_first_gan`

or, if you want to generate more samples and plot only the ones that the discriminator prefers: 
`python3 dcgan.py -m generate -f my_first_gan -bs 64 --nice`

This will trigger several actions:
1. If the `--manual_config` option is selected, a dialog will appear to enter the configuration used during training manually. Else, all the information will be loaded from `config.yaml`. The `-mc` option is used to support older versions of the code where the config file was not created.
2. The generator and discriminator models are created, according to what is said in the `config.yaml` file, and the weights are loaded to them, from the files also marked by the `config.yaml`.
3. If the `--nice` modifier is applied, `batch_size * 20` images are created with the generator, and only the `batch_size` images best classified by the discriminator are shown in a pop-up window, one by one, and saved. If the modifier is not applied, only `batch_size` images are generated, and they are all shown and saved. The images will be saved with the current date and time.

# Troubleshooting

### I see an error that says "No module named _tkinter", and no images are shown when I run `dcgan.py -d mnist`.

You probably have a python that does not come with tkinter. Make sure you are using python 3.4 or above,
and download the right python:

Ubuntu:

`sudo apt install python3-tk`

CentOS:

```
sudo yum install tkinter tk-devel openssl-devel
# Make and install python again. In the case of 3.5:
wget https://www.python.org/ftp/python/3.5.2/Python-3.5.2.tgz
tar xzf Python-3.5.2.tgz
cd Python-3.5.2
./configure
make altinstall
```

A Google search will tell you more about the problem and how to solve it in other machines.


### I see a message that says "Graphviz is not installed, therefore models will not be generated".

You need to install graphviz:

Ubuntu:

`sudo apt install graphviz`

CentOS:

`sudo yum install graphviz` 


### I get an error message like "FileNotFoundError: [Errno 2] No such file or directory: './datasets/lumps1/lumps1.npy'" or similar. 

You are trying to access a dataset that you don't have. The datasets `lumps1` and `lumps2` are datasets that I generated for my research and are too big for Github. I may upload them in the future, but I doubt it. You can generate new datasets similar to mine using the tools in the `dataset_generator` folder. Add your new datasets to the `load_dataset` function in gan_utils. Also, the cifar10 dataset has not been fully tested. Be warned!

